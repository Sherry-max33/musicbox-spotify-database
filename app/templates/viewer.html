<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Music Charts – Wireframe Demo</title>
  <style>
    :root{
      --bg:#0b0b0b;
      --panel:#121212;
      --card:#1c1c1c;
      --text:#eaeaea;
      --muted:#a7a7a7;
      --border:#2b2b2b;
      --accent:#00f5a0;
      --radius:18px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 50% -200px, rgba(0,245,160,.25), transparent 60%),
        radial-gradient(900px 500px at 90% 0px, rgba(0,194,255,.12), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:1120px;margin:0 auto;padding:22px 18px 60px}

    /* Top bar */
    .topbar{
      display:flex;align-items:center;gap:14px;
      padding:14px 14px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:rgba(18,18,18,.78);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .logo{
      display:flex;align-items:center;gap:10px;min-width:180px;
      font-weight:800;
    }
    .logo-badge{
      width:34px;height:34px;border-radius:10px;
      background:linear-gradient(135deg,var(--accent),rgba(0,245,160,.25));
      display:grid;place-items:center;color:#000;font-weight:900;
    }
    .slogan{
      font-size:12px;color:var(--muted);font-family:var(--mono);margin-top:2px;
    }
    .search{
      flex:1;display:flex;align-items:center;gap:10px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:999px;
      padding:10px 14px;
    }
    .search input{
      width:100%;
      border:0;outline:0;background:transparent;color:var(--text);
      font-size:14px;
    }
    .search input:-webkit-autofill,
    .search input:-webkit-autofill:focus{
      -webkit-box-shadow:0 0 0px 1000px rgba(255,255,255,.04) inset;
      -webkit-text-fill-color:var(--text);
      caret-color:var(--text);
    }
    .search-wrap-global{position:relative;flex:1;display:flex;}
    .search-wrap-global .search{flex:1;}
    .global-suggest{
      position:absolute;left:0;right:0;top:100%;margin:4px 0 0;padding:0;
      background:rgba(28,28,28,.98);border:1px solid var(--border);border-radius:14px;
      max-height:320px;overflow-y:auto;z-index:20;box-shadow:0 8px 24px rgba(0,0,0,.4);
    }
    .global-suggest .sect{ padding:8px 0 4px; border-bottom:1px solid rgba(255,255,255,.06); }
    .global-suggest .sect:last-child{ border-bottom:0; }
    .global-suggest .sect-title{ font-size:11px; letter-spacing:1px; color:var(--muted); font-family:var(--mono); padding:4px 18px 6px; }
    .global-suggest a{ display:block; padding:8px 18px; color:var(--text); text-decoration:none; font-size:14px; font-weight:800; }
    .global-suggest a:hover{ background:rgba(0,245,160,.12); color:var(--accent); }

    /* Section */
    .section{
      margin-top:18px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:rgba(18,18,18,.72);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .section-title{
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 18px;
      background: linear-gradient(90deg, rgba(0,245,160,.88), rgba(0,245,160,.12));
      color:#000;
      font-weight:900;
      letter-spacing:1px;
    }

    /* Controls */
    .controls{
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;
      padding:14px 18px;
      border-top:1px solid var(--border);
      background:rgba(18,18,18,.75);
    }
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      text-decoration:none;
    }
    .tab.active{
      border-color:rgba(0,245,160,.5);
      box-shadow:0 0 0 3px rgba(0,245,160,.12) inset;
    }
    .filter{
      display:flex;align-items:center;gap:8px;
      margin-left:auto;
    }
    .select{
      appearance:none;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
    }
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }
    .btn.primary{
      background:var(--accent);
      color:#000;
      border-color:rgba(0,245,160,.45);
    }

    /* Chart table */
    .chart{padding: 0 18px 18px;}
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 10px;
    }
    .thead th{
      text-align:left;
      font-size:12px;
      letter-spacing:.8px;
      color:var(--muted);
      font-family:var(--mono);
      padding:6px 10px;
    }
    .row{
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
    }
    .row td{
      padding:10px;
      vertical-align:middle;
      border-top:1px solid rgba(255,255,255,.02);
    }
    .rank{
      width:56px;
      font-family:var(--mono);
      color:var(--accent);
      font-weight:900;
      font-size:16px;
    }
    .cover{
      width:72px;height:72px;border-radius:14px;
      overflow:hidden;border:1px solid rgba(255,255,255,.08);
      flex:0 0 auto;
    }
    .cover img{width:100%;height:100%;object-fit:cover;display:block}
    .preview-cell{width:100px;vertical-align:middle}
    .preview-cell audio{display:inline-block;width:auto;max-width:100%;height:28px;min-width:0;border-radius:999px;overflow:hidden}
    .main{font-weight:850;line-height:1.15;}
    .sub{color:var(--muted);font-size:13px;margin-top:2px;}
    .play{
      display:inline-flex;align-items:center;justify-content:center;
      width:40px;height:40px;border-radius:12px;
      border:1px solid rgba(0,245,160,.4);
      background:rgba(0,245,160,.10);
      cursor:pointer;
      font-weight:900;
      color:var(--accent);
    }

    .divider{height:1px;background:var(--border);margin:22px 0 0;}

    /* Explore layout */
    .explore{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap:14px;
      padding:14px 18px 18px;
    }
    .genrelist{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:var(--radius);
      padding:12px;
      display:flex;flex-direction:column;gap:10px;
      min-height: 340px;
    }
    .genrebtn{
      text-align:left;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:11px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      text-decoration:none;
    }
    .genrebtn.active{
      background:rgba(0,245,160,.12);
      border-color:rgba(0,245,160,.45);
    }
    .exploreMain{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:var(--radius);
      padding:12px;
      overflow:hidden;
    }
    .exploreControls{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      padding:6px 4px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      margin-bottom:12px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:14px;
    }
    .card{
      background:rgba(18,18,18,.65);
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      position:relative;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
      min-height: 220px;
    }
    .card:hover{transform: translateY(-2px); border-color: rgba(0,245,160,.45);}
    .card .img{height:150px; position:relative;background:rgba(255,255,255,.04);}
    .card img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{
      position:absolute;left:12px;bottom:12px;
      width:44px;height:44px;border-radius:14px;
      background:var(--accent);
      color:#000;
      display:grid;place-items:center;
      font-weight:1000;
      font-family:var(--mono);
      box-shadow: 0 10px 18px rgba(0,245,160,.25);
    }
    .card .meta{padding:12px}
    .card .meta .t{font-weight:900}
    .card .meta .a{color:var(--muted); margin-top:6px; font-size:13px}

    @media (max-width: 980px){
      .grid{grid-template-columns: repeat(3, minmax(0, 1fr));}
      .explore{grid-template-columns: 1fr;}
      .genrelist{flex-direction:row;flex-wrap:wrap;min-height:auto}
      .genrebtn{flex: 1 1 140px;}
    }
    @media (max-width: 680px){
      .grid{grid-template-columns: repeat(2, minmax(0, 1fr));}
      .rank{width:44px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Top bar -->
    <div class="topbar">
      <div class="logo">
        <a href="{{ url_for('admin_login') }}" style="text-decoration:none;">
          <div class="logo-badge" title=" " aria-label=" " role="button">♪</div>
        </a>
        <div>
          <div style="font-size:14px;line-height:1">MusicBox</div>
          <div class="slogan">Discover your sound.</div>
        </div>
      </div>

      <div class="search-wrap-global">
        <form class="search" method="get" action="{{ url_for('search') }}" title="Search songs, artists, albums" autocomplete="off" id="globalSearchForm">
          <span style="color:var(--muted);font-family:var(--mono)">⌕</span>
          <input id="searchInput" name="q" value="{{ q or '' }}" placeholder="Search songs, artists, albums..." autocomplete="off" spellcheck="false" />
        </form>
        <div id="globalSearchSuggest" class="global-suggest" style="display:none;"></div>
      </div>
    </div>

    <!-- TOP CHARTS -->
    <section class="section" id="topCharts">
      <div class="section-title">
        <div style="font-size:34px">TOP CHARTS</div>
        <div style="font-family:var(--mono);font-size:13px">VIEW CHART</div>
      </div>

      <!-- Tabs + Decade -->
      <div class="controls">
        <div class="tabs" id="topTabs">
          <a href="{{ url_for('viewer', chart='song', decade=decade or 'All', genre=genre or '', q=q or '') }}" class="tab {{ 'active' if (chart or 'song') == 'song' else '' }}">Song Top Chart</a>
          <a href="{{ url_for('viewer', chart='artist', decade=decade or 'All', genre=genre or '', q=q or '') }}" class="tab {{ 'active' if chart == 'artist' else '' }}">Artist Top Chart</a>
          <a href="{{ url_for('viewer', chart='album', decade=decade or 'All', genre=genre or '', q=q or '') }}" class="tab {{ 'active' if chart == 'album' else '' }}">Album Top Chart</a>
        </div>

        <form class="filter" method="get" action="{{ url_for('viewer') }}" style="display:flex;align-items:center;gap:8px;margin-left:auto;">
          <input type="hidden" name="chart" value="{{ chart or 'song' }}" />
          <input type="hidden" name="genre" value="{{ genre or '' }}" />
          <input type="hidden" name="q" value="{{ q or '' }}" />
          <label style="color:var(--muted);font-family:var(--mono);font-size:12px">DECADE</label>
          <select class="select" name="decade" id="topDecade">
            {% for d in (decades or ['All','1980s','1990s','2000s','2010s','2020s']) %}
            <option value="{{ d }}" {% if (decade or 'All') == d %}selected{% endif %}>{{ d }}</option>
            {% endfor %}
          </select>
          <button type="submit" class="btn primary" id="topApply">Apply</button>
        </form>
      </div>

      <div class="chart">
        <table class="table" id="songTable" style="{{ 'display:none' if chart != 'song' else '' }}">
          <thead class="thead">
            <tr>
              <th style="width:56px">RANK</th>
              <th>COVER</th>
              <th>TRACK</th>
              <th>ARTIST</th>
              <th style="width:110px">PREVIEW</th>
            </tr>
          </thead>
          <tbody id="songBody">
            {% if chart == 'song' %}
            {% if (rows or [])|length == 0 %}
            <tr class="row">
              <td colspan="5" class="empty" style="color:var(--muted);padding:24px;text-align:center;">No songs found for this decade.</td>
            </tr>
            {% else %}
            {% for r in (rows or [])[:10] %}
            <tr class="row">
              <td class="rank">#{{ loop.index }}</td>
              <td><div class="cover">{% if r[7] %}<img src="{{ r[7] }}" loading="lazy" alt="cover" onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/cover_placeholder.png') }}';"/>{% else %}<img src="{{ url_for('static', filename='img/cover_placeholder.png') }}" alt=""/>{% endif %}</div></td>
              <td><div class="main"><a href="{{ url_for('track') }}?track_id={{ r[0] }}" style="color:inherit;text-decoration:none;">{{ r[1] }}</a></div></td>
              <td>
                <div class="sub">
                  {% if r[4] and r[5] %}
                    {% for i in range(r[5]|length) %}
                      <a href="{{ url_for('artist') }}?artist_id={{ r[4][i] }}" style="color:inherit;text-decoration:none;">{{ r[5][i] }}</a>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                  {% else %}
                    {{ r[5] }}
                  {% endif %}
                </div>
              </td>
              <td class="preview-cell">{% if r[3] %}<button type="button" class="play preview-play" data-src="{{ r[3] }}" aria-label="Play">▶</button>{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
            {% endif %}
            {% endif %}
          </tbody>
        </table>

        {% if chart == 'artist' %}
        <table class="table" id="artistTable">
          <thead class="thead">
            <tr>
              <th style="width:56px">RANK</th>
              <th>ARTIST</th>
              <th>TOP TRACK</th>
              <th style="width:100px">OPEN</th>
            </tr>
          </thead>
          <tbody>
            {% for r in (rows or [])[:10] %}
            <tr class="row">
              <td class="rank">#{{ loop.index }}</td>
              <td><div class="main"><a href="{{ url_for('artist') }}?artist_id={{ r[3] }}" style="color:inherit;text-decoration:none;">{{ r[0] }}</a></div></td>
              <td>
                <div class="sub">
                  {% if r[4] %}
                  <a href="{{ url_for('track') }}?track_id={{ r[4] }}" style="color:inherit;text-decoration:none;">{{ r[1] }}</a>
                  {% else %}
                  {{ r[1] }}
                  {% endif %}
                </div>
              </td>
              <td class="preview-cell">
                <button type="button"
                        class="play open-btn artist-open-btn"
                        data-url="{{ url_for('artist') }}?artist_id={{ r[3] }}"
                        aria-label="Open artist"
                        title="Open artist">↗</button>
              </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% endif %}
        {% if chart == 'album' %}
        <table class="table" id="albumTable">
          <thead class="thead">
            <tr>
              <th style="width:56px">RANK</th>
              <th>COVER</th>
              <th>ALBUM</th>
              <th>ARTIST</th>
              <th style="width:100px">OPEN</th>
            </tr>
          </thead>
          <tbody>
            {% for r in (rows or [])[:10] %}
            <tr class="row">
              <td class="rank">#{{ loop.index }}</td>
              <td><div class="cover"><img src="{{ r[2] or url_for('static', filename='img/cover_placeholder.png') }}" loading="lazy" alt="" onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/cover_placeholder.png') }}';"/></div></td>
              <td><div class="main"><a href="{{ url_for('album') }}?album_id={{ r[0] }}" style="color:inherit;text-decoration:none;">{{ r[1] }}</a></div></td>
              <td><div class="sub">{% if r[3] %}<a href="{{ url_for('artist') }}?artist_id={{ r[3] }}" style="color:inherit;text-decoration:none;">{{ r[4] }}</a>{% else %}{{ r[4] }}{% endif %}</div></td>
              <td class="preview-cell">
                <button type="button"
                        class="play open-btn album-open-btn"
                        data-url="{{ url_for('album') }}?album_id={{ r[0] }}"
                        aria-label="Open album"
                        title="Open album">↗</button>
              </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% endif %}

        <div class="divider"></div>

        <div style="padding:18px 0 0 0; font-weight:1000; letter-spacing:1px">
          <span style="color:var(--muted);font-family:var(--mono)">##</span>
          <span style="margin-left:8px">EXPLORE BY GENRES</span>
        </div>

        <div class="explore">
          <!-- Left: 7 genres -->
          <div class="genrelist" id="genreList">
            {% for g in (genres or []) %}
            <a href="{{ url_for('viewer', genre=g, decade=decade or 'All', chart=chart or 'song', q=q or '') }}" class="genrebtn {{ 'active' if (genre or '') == g else '' }}" data-genre="{{ g }}">{{ g }}</a>
            {% endfor %}
          </div>

          <!-- Right: Decade + type tabs -->
          <div class="exploreMain">
            <div class="exploreControls">
              <div style="display:flex;align-items:center;gap:8px;margin-right:auto">
                <label style="color:var(--muted);font-family:var(--mono);font-size:12px">DECADE</label>
                <select class="select" id="genreDecade">
                  <option value="all">All</option>
                  <option value="1980s">1980s</option>
                  <option value="1990s">1990s</option>
                  <option value="2000s">2000s</option>
                  <option value="2010s">2010s</option>
                  <option value="2020s">2020s</option>
                </select>
              </div>

              <div class="tabs" id="genreTabs">
                <button class="tab active" data-tab="songs">Songs</button>
                <button class="tab" data-tab="artists">Artists</button>
                <button class="tab" data-tab="albums">Albums</button>
              </div>
            </div>

            <div class="grid" id="genreGrid"></div>
            <p id="genreGridStatus" style="color:var(--muted);font-size:13px;margin-top:12px;display:none;"></p>
          </div>
        </div>
      </div>
    </section>
  </div>
  <audio id="previewAudio" preload="none" style="display:none"></audio>

<script>
var HAS_SERVER_ROWS = {{ 'true' if (rows and rows|length > 0) else 'false' }};
var HAS_SERVER_GENRES = {{ 'true' if (genres and genres|length > 0) else 'false' }};
var INITIAL_GENRE = {{ (genre or '')|tojson }};
var COVER_PLACEHOLDER = {{ url_for('static', filename='img/cover_placeholder.png')|tojson }};
// ---- same demo data as before (shortened for brevity) ----
const COVERS = {
  afterHours: "https://archive.org/download/mbid-fd7ebee8-8c64-4127-a9be-8e31ed6364e3/mbid-fd7ebee8-8c64-4127-a9be-8e31ed6364e3-28418011574_thumb500.jpg",
  adele21: "https://archive.org/download/mbid-57440dfc-191c-32bd-ada0-14ac366c2a12/mbid-57440dfc-191c-32bd-ada0-14ac366c2a12-835722588_thumb500.jpg",
  okComputer: "https://archive.org/download/mbid-fba5f8fe-c6c8-4511-8562-c9febf482674/mbid-fba5f8fe-c6c8-4511-8562-c9febf482674-26537574690_thumb500.jpg",
  thriller: "https://archive.org/download/mbid-1d9b9dce-6584-37c7-a2a8-fabca91136c2/mbid-1d9b9dce-6584-37c7-a2a8-fabca91136c2-25091040839_thumb500.jpg",
  outkast: "https://archive.org/download/mbid-468cd19e-d55c-46a2-a5a6-66292d2f0a90/mbid-468cd19e-d55c-46a2-a5a6-66292d2f0a90-23968933675_thumb500.jpg"
};

const TOP_ARTISTS = [
  {rank:1, artist:"The Weeknd", topTrack:"Blinding Lights", decade:"2020s"},
  {rank:2, artist:"Adele", topTrack:"Rolling in the Deep", decade:"2010s"},
  {rank:3, artist:"OutKast", topTrack:"Hey Ya!", decade:"2000s"},
  {rank:4, artist:"Radiohead", topTrack:"Karma Police", decade:"1990s"},
  {rank:5, artist:"Michael Jackson", topTrack:"Billie Jean", decade:"1980s"}
];

const TOP_ALBUMS = [
  {rank:1, album:"After Hours", artist:"The Weeknd", decade:"2020s", cover:COVERS.afterHours},
  {rank:2, album:"21", artist:"Adele", decade:"2010s", cover:COVERS.adele21},
  {rank:3, album:"Speakerboxxx / The Love Below", artist:"OutKast", decade:"2000s", cover:COVERS.outkast},
  {rank:4, album:"OK Computer", artist:"Radiohead", decade:"1990s", cover:COVERS.okComputer},
  {rank:5, album:"Thriller (Special Edition)", artist:"Michael Jackson", decade:"1980s", cover:COVERS.thriller}
];

// 7 genres
const GENRES = [
  {key:"Pop", items:[]},
  {key:"Rock", items:[]},
  {key:"Hip-Hop", items:[]},
  {key:"R&B", items:[]},
  {key:"Jazz", items:[]},
  {key:"Classical", items:[]},
  {key:"Electronic", items:[]},
  {key:"Country", items:[]}
];

const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));

var previewAudio = document.getElementById("previewAudio");
if (previewAudio) {
  function setAllPlayIcons() {
    $$(".preview-play").forEach(function(btn){ btn.textContent = "▶"; });
  }
  previewAudio.addEventListener("pause", setAllPlayIcons);
  previewAudio.addEventListener("ended", setAllPlayIcons);
  document.addEventListener("click", function(e) {
    var btn = e.target.closest(".preview-play");
    if (!btn || !btn.dataset.src) return;
    var src = btn.dataset.src;
    if (previewAudio.src !== src || previewAudio.paused) {
      setAllPlayIcons();
      previewAudio.src = src;
      previewAudio.play();
      btn.textContent = "❚❚";
    } else {
      previewAudio.pause();
      btn.textContent = "▶";
    }
  });
}

// Artist open buttons: navigate to artist detail
document.addEventListener("click", function(e){
  var btn = e.target.closest(".artist-open-btn") || e.target.closest(".album-open-btn");
  if (!btn || !btn.dataset.url) return;
  window.location.href = btn.dataset.url;
});

// Global search dropdown (match suggestions like analyst edit)
(function(){
  var apiUrl = "{{ url_for('search_api') }}";
  var artistBase = "{{ url_for('artist') }}";
  var albumBase = "{{ url_for('album') }}";
  var trackBase = "{{ url_for('track') }}";
  var input = document.getElementById("searchInput");
  var dropdown = document.getElementById("globalSearchSuggest");
  var wrap = input && input.closest(".search-wrap-global");
  if (!input || !dropdown || !wrap) return;
  function debounce(fn, ms){ var t; return function(){ clearTimeout(t); t = setTimeout(fn, ms); }; }
  function esc(s){ return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;"); }
  function showSuggest(data){
    var artists = (data && data.artists) || [];
    var albums = (data && data.albums) || [];
    var tracks = (data && data.tracks) || [];
    var html = "";
    if (artists.length) {
      html += "<div class=\"sect\"><div class=\"sect-title\">ARTISTS</div>";
      artists.forEach(function(o){ html += "<a href=\"" + artistBase + "?artist_id=" + esc(o.id) + "\">" + esc(o.name) + "</a>"; });
      html += "</div>";
    }
    if (albums.length) {
      html += "<div class=\"sect\"><div class=\"sect-title\">ALBUMS</div>";
      albums.forEach(function(o){ html += "<a href=\"" + albumBase + "?album_id=" + esc(o.id) + "\">" + esc(o.name) + "</a>"; });
      html += "</div>";
    }
    if (tracks.length) {
      html += "<div class=\"sect\"><div class=\"sect-title\">TRACKS</div>";
      tracks.forEach(function(o){ html += "<a href=\"" + trackBase + "?track_id=" + esc(o.id) + "\">" + esc(o.name) + "</a>"; });
      html += "</div>";
    }
    if (!html) html = "<div class=\"sect\"><div class=\"sect-title\" style=\"color:var(--muted)\">No results</div></div>";
    dropdown.innerHTML = html;
    dropdown.style.display = "block";
  }
  input.addEventListener("input", debounce(function(){
    var q = input.value.trim();
    if (!q){ dropdown.style.display = "none"; return; }
    fetch(apiUrl + "?q=" + encodeURIComponent(q)).then(function(r){ return r.json(); }).then(showSuggest).catch(function(){ showSuggest([]); });
  }, 200));
  input.addEventListener("focus", function(){ if (dropdown.innerHTML) dropdown.style.display = "block"; });
  dropdown.addEventListener("click", function(e){
    var a = e.target.closest("a[href]");
    if (a){ e.preventDefault(); window.location.href = a.getAttribute("href"); }
  });
  document.addEventListener("click", function(e){ if (!e.target.closest(".search-wrap-global")) dropdown.style.display = "none"; });
})();

function playMock(label){
  alert("Preview (mock): " + label);
}

// render TOP charts
function renderTop(decade="all"){
  const q = ($("#searchInput").value||"").toLowerCase();
  const filterDecade = x => decade==="all" || x.decade===decade;
  const filterSearch = t => !q || t.toLowerCase().includes(q);

  // Song chart: always server-rendered from /viewer; no static mock injection.

  // artists
  const artists = TOP_ARTISTS.filter(filterDecade);
  $("#artistBody").innerHTML = artists.map(a=>`
    <tr class="row">
      <td class="rank">#${a.rank}</td>
      <td><div class="main">${a.artist}</div></td>
      <td><div class="sub">${a.topTrack}</div></td>
      <td><button class="play" onclick="playMock('${a.topTrack}')">▶</button></td>
    </tr>
  `).join("");

  // albums
  const albums = TOP_ALBUMS.filter(filterDecade);
  $("#albumBody").innerHTML = albums.map(a=>`
    <tr class="row">
      <td class="rank">#${a.rank}</td>
      <td><div class="cover"><img src="${a.cover}" loading="lazy"/></div></td>
      <td><div class="main">${a.album}</div></td>
      <td><div class="sub">${a.artist}</div></td>
      <td><button class="play" onclick="alert('Open: ${a.album}')">↗</button></td>
    </tr>
  `).join("");
}

// tabs: now use <a> links; no click handler needed for chart switch
// Apply: form submit; no extra handler
if (!HAS_SERVER_ROWS) {
  $("#topTabs").addEventListener("click", e=>{
    const btn = e.target.closest(".tab"); if(!btn) return;
    $$("#topTabs .tab").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    const t = btn.dataset.tab;
    $("#songTable").style.display = t==="songs"?"":"none";
    $("#artistTable").style.display = t==="artists"?"":"none";
    $("#albumTable").style.display = t==="albums"?"":"none";
  });
  $("#topApply").addEventListener("click", ()=>{ renderTop($("#topDecade").value); });
}

// build left genre list: sync with URL when server provides genres
var genreListEl = $("#genreList");
var activeGenre = (INITIAL_GENRE && GENRES.some(g=>g.key===INITIAL_GENRE)) ? INITIAL_GENRE : GENRES[0].key;
var activeGenreTab = "songs";
var TRACK_BASE = {{ url_for('track')|tojson }};
var ARTIST_BASE = {{ url_for('artist')|tojson }};
var ALBUM_BASE = {{ url_for('album')|tojson }};
var linkStyle = "color:inherit;text-decoration:none";

function esc(s){ return (s||"").replace(/</g,"&lt;").replace(/&/g,"&amp;").replace(/"/g,"&quot;"); }

function renderGenreCards(items, type){
  if (!items || items.length === 0) {
    $("#genreGrid").innerHTML = "";
    return;
  }
  var placeholder = typeof COVER_PLACEHOLDER !== "undefined" ? COVER_PLACEHOLDER : "";
  if (type === "songs") {
    $("#genreGrid").innerHTML = items.map((x,i)=>{
      var rank = x.rank != null ? x.rank : (i+1);
      var cover = (x.album_image_url || placeholder);
      var preview = (x.preview_url ? `<button type="button" class="preview-play" style="position:absolute;right:10px;bottom:10px;width:36px;height:36px;border-radius:50%;border:0;background:var(--accent);color:#000;cursor:pointer;font-size:14px;" data-src="${(x.preview_url||"").replace(/"/g,"&quot;")}" aria-label="Preview">▶</button>` : "");
      var t = esc(x.track_name);
      var a = esc(x.artist_name);
      var trackHtml = (x.track_id ? `<a href="${TRACK_BASE}?track_id=${encodeURIComponent(x.track_id)}" style="${linkStyle}">${t}</a>` : t);
      var artistHtml = (x.artist_id ? `<a href="${ARTIST_BASE}?artist_id=${encodeURIComponent(x.artist_id)}" style="${linkStyle}">${a}</a>` : a);
      return `<div class="card">
        <div class="img" style="position:relative">
          <img src="${cover}" loading="lazy" onerror="this.onerror=null;this.src='${placeholder}';"/>
          <div class="badge">${rank}</div>${preview}
        </div>
        <div class="meta">
          <div class="t">${trackHtml}</div>
          <div class="a">${artistHtml}</div>
        </div>
      </div>`;
    }).join("");
  } else if (type === "artists") {
    $("#genreGrid").innerHTML = items.map((x,i)=>{
      var rank = x.rank != null ? x.rank : (i+1);
      var cover = (x.album_image_url || placeholder);
      var preview = (x.preview_url ? `<button type="button" class="preview-play" style="position:absolute;right:10px;bottom:10px;width:36px;height:36px;border-radius:50%;border:0;background:var(--accent);color:#000;cursor:pointer;font-size:14px;" data-src="${(x.preview_url||"").replace(/"/g,"&quot;")}" aria-label="Preview">▶</button>` : "");
      var name = esc(x.artist_name);
      var topTrack = esc(x.top_track_name||"");
      var artistHtml = (x.artist_id ? `<a href="${ARTIST_BASE}?artist_id=${encodeURIComponent(x.artist_id)}" style="${linkStyle}">${name}</a>` : name);
      return `<div class="card">
        <div class="img" style="position:relative">
          <img src="${cover}" loading="lazy" onerror="this.onerror=null;this.src='${placeholder}';"/>
          <div class="badge">${rank}</div>${preview}
        </div>
        <div class="meta">
          <div class="t">${artistHtml}</div>
          <div class="a">${topTrack}</div>
        </div>
      </div>`;
    }).join("");
  } else {
    $("#genreGrid").innerHTML = items.map((x,i)=>{
      var rank = x.rank != null ? x.rank : (i+1);
      var cover = (x.album_image_url || placeholder);
      var albumName = esc(x.album_name||"");
      var artistName = esc(x.artist_name||"");
      var albumHtml = (x.album_id ? `<a href="${ALBUM_BASE}?album_id=${encodeURIComponent(x.album_id)}" style="${linkStyle}">${albumName}</a>` : albumName);
      var artistHtml = (x.artist_id ? `<a href="${ARTIST_BASE}?artist_id=${encodeURIComponent(x.artist_id)}" style="${linkStyle}">${artistName}</a>` : artistName);
      return `<div class="card">
        <div class="img">
          <img src="${cover}" loading="lazy" onerror="this.onerror=null;this.src='${placeholder}';"/>
          <div class="badge">${rank}</div>
        </div>
        <div class="meta">
          <div class="t">${albumHtml}</div>
          <div class="a">${artistHtml}</div>
        </div>
      </div>`;
    }).join("");
  }
}

function fetchAndRenderGenreGrid(){
  var statusEl = document.getElementById("genreGridStatus");
  if (!HAS_SERVER_GENRES) {
    var genre = GENRES.find(g=>g.key===activeGenre);
    var items = (genre&&genre.items) ? genre.items.filter(x=>x.type===activeGenreTab) : [];
    var decade = $("#genreDecade").value;
    if (decade !== "all") items = items.filter(x=>x.decade===decade);
    renderGenreCards(items.map((x,i)=>({ rank: i+1, track_name: x.title, artist_name: x.artist, album_image_url: x.cover })), "songs");
    if (statusEl) { statusEl.style.display = "none"; }
    return;
  }
  if (statusEl) { statusEl.textContent = "Loading…"; statusEl.style.display = "block"; }
  var decade = ($("#genreDecade")&&$("#genreDecade").value) ? $("#genreDecade").value : "all";
  var type = activeGenreTab === "songs" ? "songs" : (activeGenreTab === "artists" ? "artists" : "albums");
  var url = "{{ url_for('viewer_genre_chart') }}?genre=" + encodeURIComponent(activeGenre) + "&decade=" + encodeURIComponent(decade) + "&type=" + encodeURIComponent(type);
  fetch(url)
    .then(function(r){ return r.json(); })
    .then(function(data){
      var items = (data && data.items) ? data.items : [];
      renderGenreCards(items, type);
      if (statusEl) {
        if (items.length === 0) { statusEl.textContent = "No data"; statusEl.style.display = "block"; }
        else statusEl.style.display = "none";
      }
    })
    .catch(function(err){
      renderGenreCards([], type);
      if (statusEl) { statusEl.textContent = "Failed to load"; statusEl.style.display = "block"; }
    });
}

const gl = $("#genreList");
if (!HAS_SERVER_GENRES) {
  gl.innerHTML = GENRES.map(g=>`
    <button class="genrebtn ${g.key===activeGenre?"active":""}" data-genre="${g.key}">${g.key}</button>
  `).join("");
  gl.addEventListener("click", e=>{
    const btn = e.target.closest(".genrebtn"); if(!btn) return;
    activeGenre = btn.dataset.genre;
    $$("#genreList .genrebtn").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    fetchAndRenderGenreGrid();
  });
} else {
  // Server-rendered genre links: intercept click to avoid full reload and scroll to top
  gl.addEventListener("click", function(e) {
    var btn = e.target.closest(".genrebtn");
    if (!btn || !btn.dataset.genre) return;
    e.preventDefault();
    activeGenre = btn.dataset.genre;
    $$("#genreList .genrebtn").forEach(function(x){ x.classList.remove("active"); });
    btn.classList.add("active");
    var href = btn.getAttribute("href");
    if (window.history && window.history.pushState && href) {
      window.history.pushState({ genre: activeGenre }, "", href);
    }
    fetchAndRenderGenreGrid();
  });
  fetchAndRenderGenreGrid();
}

$("#genreTabs").addEventListener("click", e=>{
  const btn = e.target.closest(".tab"); if(!btn) return;
  $$("#genreTabs .tab").forEach(x=>x.classList.remove("active"));
  btn.classList.add("active");
  activeGenreTab = btn.dataset.tab;
  fetchAndRenderGenreGrid();
});

$("#genreDecade").addEventListener("change", fetchAndRenderGenreGrid);

// init
renderTop("all");
fetchAndRenderGenreGrid();
</script>
</body>
</html>
